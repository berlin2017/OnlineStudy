<view class='main_container' catchtap='chatingWrapperClick' style='height:100%;'>

  <include src='../common/title' />

  <view class='content'>
    <view class='chating-wrapper'>
      <!-- 视频全屏播放区 -->
      <view wx:if="{{isVideoFullScreen}}" style='position:fixed;top:0;bottom:0;right:0;left:0;z-index:999;background-color:#000;'>
        <video id="videoEle" src="{{videoSrc}}" bindended="videoEnded" show-fullscreen-btn="{false}" controls style='width:100%;height:100%;'></video>
      </view>
      <!-- tip消息 -->
      <view catchtap='stopEventPropagation'>
        <input-modal wx:if="{{tipFlag}}" title="输入提醒" catch:inputModalClick="tipClickHandler">
          <input placeholder='请输入文本' type='text' confirm-type='send' class='modal-input' bindinput='tipInputChange' bindconfirm='tipInputConfirm' style="margin-left:10rpx;"></input>
        </input-modal>
      </view>
      <!-- 历史消息 -->
      <!-- <view class='chating-history' catchtap='lookHistoryMessage'>
        <text class='chating-history-left'>历史消息</text>
        <text class='chating-history-right'>></text>
      </view> -->
      <!-- 消息记录 -->
      <view class='record-wrapper' id="recordWrapper">
        <view wx:for="{{messageArr}}" wx:for-item="message" wx:key="{{message.time}}" id='item_{{index}}'>
          <view class='record-item-time-wrapper' wx:if="{{message.ctime_ms}}">
            <text class='record-item-time'>{{message.ctime_ms}}</text>
          </view>
          <view wx:if="{{message.from_username != toId}}" class='record-chatting-item self' style='justify-content: {{message.type === "tip" ? "center" : "flex-end"}}' data-message="{{message}}" bindlongpress='showEditorMenu'>

            <view wx:if="{{message.content.msg_type === 'geo'}}" data-geo='{{message.geo}}' class='small-map-wrapper' catchtap='fullScreenMap'>
              <image src="{{iconBase64Map.iconMap}}" class='small-geo-img'></image>
              <text class='text'>{{message.geo.title}}</text>
            </view>

            <view wx:if="{{message.content.msg_type === 'video'}}" data-video="{{message.video}}" catchtap='requestFullScreenVideo' class='small-video-wrapper'>
              <view class='video-triangle'></view>
              <view style='color: #000;'>{{message.video.dur / 1000
                << 1>> 1}}''</view>
            </view>

            <view wx:if="{{message.content.msg_type === 'file'}}" class='audio-wrapper' data-audio="{{message.content.msg_body.media_id}}" catchtap='playAudio' style='background-color:rgb(128,161,213);color: #000;'>
              <image src='{{iconBase64Map.iconVoiceWhite}}' class='image'></image>
              <text class='text'>{{message.audio.dur / 1000 << 1 >> 1}}''</text>
            </view>

            <image wx:if="{{message.content.msg_type === 'image'}}" src='{{message.content.msg_body.media_id}}' class='record-chatting-item-text' style='width:{{message.content.msg_body.width}}px;height:{{message.content.msg_body.height}}px' bindtap='previewImage'
              data-src='{{message.content.msg_body.media_id}}'></image>

            <rich-text nodes="{{message.nodes}}" wx:if="{{message.content.msg_type === 'text'}}" class='record-chatting-item-text'>{{message.content.msg_body.text}}</rich-text>

            <text wx:if="{{message.content.msg_type !== 'tip'}}" class='right-triangle'></text>
            <image wx:if="{{message.content.msg_type !== 'tip'}}" src='{{loginAccountLogo}}' catchtap='switchToMyTab' class='record-chatting-item-img'></image>
          </view>

          <view wx:if="{{message.from_username === toId}}" class='record-chatting-item other' style='justify-content: {{message.content.msg_type === "tip" ? "center" : "flex-start"}}' data-message="{{message}}" bindlongpress='showEditorMenu'>
            <image wx:if="{{message.content.msg_type !== 'tip'}}" catchtap='switchPersonCard' src='{{chatToLogo}}' class='record-chatting-item-img'></image>
            <text wx:if="{{message.content.msg_type !== 'tip'}}" class='left-triangle'></text>

            <view wx:if="{{message.content.msg_type === 'geo'}}" data-geo='{{message.geo}}' class='small-map-wrapper' catchtap='fullScreenMap'>
              <image src="{{iconBase64Map.iconMap}}" class='small-geo-img'></image>
              <text class='text'>{{message.geo.title}}</text>
            </view>

            <view wx:if="{{message.content.msg_type === 'video'}}" data-video="{{message.video}}" catchtap='requestFullScreenVideo' class='small-video-wrapper'>
              <view class='video-triangle'></view>
              <view style='color: #000;'>{{message.video.dur / 1000
                << 1>> 1}}''</view>
            </view>

            <view wx:if="{{message.content.msg_type === 'file'}}" data-audio="{{message.content.msg_body.media_id}}" catchtap='playAudio' class='audio-wrapper'>
              <image src='{{iconBase64Map.iconVoiceGrey}}' class='image'></image>
              <text class='text' style='color:#000;'>{{message.audio.dur / 1000 << 1 >> 1}}''</text>
            </view>

            <rich-text wx:if="{{message.content.msg_type === 'text'}}" class='record-chatting-item-text' style='color:#000;background-color:#fff;'>{{message.content.msg_body.text}}</rich-text>
            <image wx:if="{{message.content.msg_type === 'image'}}" src='{{message.content.msg_body.media_id}}' class='record-chatting-item-text' style='width:{{message.content.msg_body.width}}px;height:{{message.content.msg_body.height}}px' bindtap='previewImage'
              data-src='{{message.content.msg_body.media_id}}'></image>
            <rich-text wx:if="{{message.content.msg_type === 'tip'}}" class='tip-rich-text'>{{message.text}}</rich-text>
          </view>

        </view>

      </view>


      <!--底部输入框  -->
      <view class='chatinput-wrapper' style='margin-bottom: {{focusFlag ? 20 : 0}}rpx;' catchtap='stopEventPropagation'>
        <view class='chatinput-content'>
          <image src='{{sendType == 0 ? "../Resources/voice.png" : "../Resources/keyboard.png"}}' class='chatinput-img' catchtap='switchSendType'></image>
          <input style='margin-bottom: 20rpx;' wx:if="{{sendType == 0}}" value='{{inputValue}}' focus='{{focusFlag}}' bindinput='inputChange' bindfocus='inputFocus' bindblur='inputBlur' bindconfirm='inputSend' class='chatinput-input' placeholder="输入文字" confirm-type='send'></input>
          <!-- <button wx:if="{{sendType == 1}}" class="{{ isLongPress ? 'chatinput-voice-mask chatinput-voice-mask-hover' : 'chatinput-voice-mask' }}" hover-class="none" catchtouchstart='longPressStart' catchlongpress='voiceBtnLongTap' catchtouchend='longPressEnd'>按住说话</button> -->
          <button wx:if="{{sendType == 1}}" class="{{ isLongPress ? 'chatinput-voice-mask chatinput-voice-mask-hover' : 'chatinput-voice-mask' }}" hover-class="none" catchtouchstart='longPressStart' catchtouchend='longPressEnd'>按住说话</button>
          <image src='../Resources/more.png' catchtap='toggleMore' class='chatinput-img fr'></image>
          <!-- <image src='../Resources/emoji.png' catchtap='toggleEmoji' class='chatinput-img fr'></image> -->
        </view>
        <view wx:if="{{emojiFlag}}" class='chatinput-subcontent'>
          <component-emoji bind:EmojiClick="emojiCLick" bind:EmojiSend="emojiSend"></component-emoji>
        </view>
        <view wx:if="{{moreFlag}}" class='more-subcontent'>
          <view style='display:flex;justify-content: space-between;'>
            <view class='more-subcontent-item' catchtap='chooseImageToSend'>
              <image src="../Resources/iconImage@2x.png" class='image'></image>
              <text class='text'>图片</text>
            </view>
            <view class='more-subcontent-item' catchtap='showCall' data-type='0'>
              <image src="../Resources/vioce_call.png" class='image'></image>
              <text class='text'>语音通话</text>
            </view>
            <view class='more-subcontent-item' catchtap='showCall' data-type='1'>
              <image class='image' src='../Resources/video_call.png'></image>
              <text class='text'>视频通话</text>
            </view>

            <!-- <view class='more-subcontent-item' catchtap='chooseImageOrVideo'>
              <image src="{{iconBase64Map.iconCapture}}" class='image'></image>
              <text class='text'>视频</text>
            </view> -->
            <!-- <view class='more-subcontent-item'><view class='image'></view><text class='text'>文件</text></view> -->
            <!-- <view class='more-subcontent-item' catchtap='sendTipMessage'>
              <image src="{{iconBase64Map.iconTip}}" class='image'></image>
              <text class='text'>Tip</text>
            </view>
            <view class='more-subcontent-item' catchtap='sendFingerGuess'>
              <image src="{{iconBase64Map.iconFingerGuess}}" class='image'></image>
              <text class='text'>猜拳</text>
            </view> -->

          </view>
          <!-- <view style='display:flex;justify-content: space-between;'>
            <view class='more-subcontent-item' catchtap='choosePosition'>
              <image src="{{iconBase64Map.iconPosition}}" class='image'></image>
              <text class='text'>位置</text>
            </view>
            <view class='more-subcontent-item'>
              <view class='image' style='background-color: transparent;'></view>
              <text class='text'></text>
            </view>
            <view class='more-subcontent-item'>
              <view class='image' style='background-color: transparent;'></view>
              <text class='text'></text>
            </view>
          </view> -->
        </view>
      </view>
    </view>

  </view>
</view>

<view class='invite_layout' style='width:100%;height:100%;position:fixed;top:0px;z-index:1000000;background:gray;' wx:if='{{showCall}}'>

  <view class='top_layout' style='margin-top:40px;display:relative;'>
    <image src='{{chatToLogo}}' class='call_logo' wx:if='{{chatToLogo}}' style='width:60px;height:60px;margin-left:20px;float:left;'></image>
    <image src='../Resources/default-icon.png' class='call_logo' wx:if='{{!chatToLogo}}' style='width:60px;height:60px;margin-left:20px;float:left;'></image>
    <view style='float:left;margin-left:15px;'>
      <view class='call_nickname' style='font-size:17px;color:white;'>{{toNickName}}</view>
      <view class='call_tip' style='font-size:13px;color:white;'>正在等待对方接受邀请</view>
    </view>

  </view>

  <view class='bottom_layout' style='bottom:20px;display:absolute;position:fixed;text-align:center;width:100%;'>
    <image src='../Resources/uncall.png' class='end_call' style='width:60px;height:60px;border-radius:30px;' bindtap='cancelCall'></image>
    <view class='cancel_text' style='font-size:13px;color:white;'>取消</view>
  </view>
</view>


<view class='invited_layout' style='width:100%;height:100%;position:fixed;top:0px;z-index:1000000;background:gray;' wx:if='{{showInvite}}'>

  <view class='top_layout' style='margin-top:40px;display:relative;'>
    <image src='{{chatToLogo}}' class='call_logo' wx:if='{{chatToLogo}}' style='width:60px;height:60px;margin-left:20px;float:left;'></image>
    <image src='../Resources/default-icon.png' class='call_logo' wx:if='{{!chatToLogo}}' style='width:60px;height:60px;margin-left:20px;float:left;'></image>
    <view style='float:left;margin-left:15px;'>
      <view class='call_nickname' style='font-size:17px;color:white;'>{{toNickName}}</view>
      <view class='call_tip' style='font-size:13px;color:white;'>{{call_type == 0 ? "邀请你进行语音通话" : "邀请你进行视频通话"}}</view>
    </view>

  </view>

  <view class='bottom_layout' style='bottom:20px;display:absolute;position:fixed;text-align:center;left:20px;'>
    <image src='../Resources/uncall.png' class='end_call' style='width:60px;height:60px;border-radius:30px;' bindtap='cancelInvite'></image>
    <view class='cancel_text' style='font-size:13px;color:white;'>取消</view>
  </view>

  <view class='bottom_layout' style='bottom:20px;display:absolute;position:fixed;text-align:center;right:20px;'>
    <image src='../Resources/call_accept.png' class='end_call' style='width:40px;height:40px;background:green;border-radius:30px;padding:10px;' bindtap='acceptInvite'></image>
    <view class='cancel_text' style='font-size:13px;color:white;'>接听</view>
  </view>

</view>

<view class='voicecall_layout' style='width:100%;height:100%;position:fixed;top:0px;z-index:1000000;background:gray;' wx:if='{{calling}}'>

  <view class='top_layout' style='margin-top:40px;display:relative;' wx:if='{{call_type != 1}}'>
    <image src='{{chatToLogo}}' class='call_logo' wx:if='{{chatToLogo}}' style='width:60px;height:60px;margin-left:20px;float:left;'></image>
    <image src='../Resources/default-icon.png' class='call_logo' wx:if='{{!chatToLogo}}' style='width:60px;height:60px;margin-left:20px;float:left;'></image>
    <view style='float:left;margin-left:15px;'>
      <view class='call_nickname' style='font-size:17px;color:white;'>{{toNickName}}</view>
      <view class='call_tip' style='font-size:13px;color:white;'>通话中...</view>
    </view>

  </view>


  <!-- <camera device-position="front" flash="off" binderror="error" style="width: 180px;; height: 320px;position:relative;" wx:if='{{call_type == 1}}'> -->

    <!-- <cover-view style='width:100%;position:absolute;bottom:10px;'>
    
    <cover-image src='../Resources/uncall.png' class='end_call' style='width:60px;height:60px;border-radius:30px;margin-left:auto;margin-right:auto;' bindtap='endCall'></cover-image>
    <cover-view class='cancel_text' style='font-size:13px;color:white;margin-left:auto;margin-right:auto;text-align:center;margin-top:10px;'>取消</cover-view>

    </cover-view> -->

  <!-- </camera> -->

  <live-pusher url='{{selfPush}}' style="width: 160px;; height: 240px;position:relative;" wx:if='{{call_type == 1}}'>


  </live-pusher>


   <!-- <live-player src='{{otherPlay}}' style="width: 100%; height: 100%;position:relative;" wx:if='{{call_type == 1}}'>

  </live-player> -->

 <view class='bottom_layout' style='bottom:20px;display:absolute;position:fixed;text-align:center;width:100%;'>
    <image src='../Resources/uncall.png' class='end_call' style='width:60px;height:60px;border-radius:30px;' bindtap='cancelCall'></image>
    <view class='cancel_text' style='font-size:13px;color:white;'>取消</view>
  </view>

</view>